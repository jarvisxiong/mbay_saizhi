<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="TrafficRedCampaignMbay">
	<resultMap id="BaseResultMap" type="trafficRedCampaignMbay">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Apr 01 
			10:17:14 CST 2015. -->
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="campaignId" property="campaignId" jdbcType="BIGINT" />
		<result column="ratio" property="ratio" jdbcType="INTEGER" />
		<association column="mbayId" property="mbay" javaType="trafficRedMbay">
			<id column="mbayId" property="id" />
			<result column="mbay" property="mbay" />
		</association>
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Apr 01 
			10:17:14 CST 2015. -->
		id, campaignId, mbayId, ratio
	</sql>
	<select id="selectById" resultMap="BaseResultMap" parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Apr 01 
			10:17:14 CST 2015. -->
		select
		<include refid="Base_Column_List" />
		from tr_campaign_mbay
		where id = #{id,jdbcType=BIGINT}
	</select>
	<delete id="deleteById" parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Apr 01 
			10:17:14 CST 2015. -->
		delete from tr_campaign_mbay
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<insert id="create" parameterType="trafficRedCampaignMbay">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Apr 01 
			10:17:14 CST 2015. -->
		insert into tr_campaign_mbay (id, campaignId, mbayId, ratio)
		values (#{id,jdbcType=BIGINT},
		#{campaignId,jdbcType=BIGINT},
		#{mbay.id,jdbcType=BIGINT},
		#{ratio,jdbcType=INTEGER})
	</insert>
	<insert id="createSelective" parameterType="trafficRedCampaignMbay">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Apr 01 
			10:17:14 CST 2015. -->
		insert into tr_campaign_mbay
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="campaignId != null">
				campaignId,
			</if>
			<if test="mbay != null">
				mbayId,
			</if>
			<if test="ratio != null">
				ratio,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=BIGINT},
			</if>
			<if test="campaignId != null">
				#{campaignId,jdbcType=BIGINT},
			</if>
			<if test="mbay != null">
				#{mbay.id,jdbcType=BIGINT},
			</if>
			<if test="ratio != null">
				#{ratio,jdbcType=INTEGER},
			</if>
		</trim>
	</insert>
	<update id="updateByIdSelective" parameterType="trafficRedCampaignMbay">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Apr 01 
			10:17:14 CST 2015. -->
		update tr_campaign_mbay
		<set>
			<if test="campaignId != null">
				campaignId = #{campaignId,jdbcType=BIGINT},
			</if>
			<if test="mbay != null">
				mbayId = #{mbay.id,jdbcType=BIGINT},
			</if>
			<if test="ratio != null">
				ratio = #{ratio,jdbcType=INTEGER},
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateById" parameterType="trafficRedCampaignMbay">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Apr 01 
			10:17:14 CST 2015. -->
		update tr_campaign_mbay
		set campaignId = #{campaignId,jdbcType=BIGINT},
		mbayId = #{mbay.id,jdbcType=BIGINT},
		ratio = #{ratio,jdbcType=INTEGER}
		where id = #{id,jdbcType=BIGINT}
	</update>

	<select id="findByCampaignId" resultMap="BaseResultMap" parameterType="java.lang.Long">
		select c.id, c.campaignId, c.mbayId, c.ratio, t.mbay
		from tr_campaign_mbay c
		inner join tr_mbay t on c.mbayId = t.id
		where campaignid = #{cid,jdbcType=BIGINT}
	</select>

	<delete id="deleteByCampaignId" parameterType="java.lang.Long">
		delete from tr_campaign_mbay where campaignId=#{cid,jdbcType=BIGINT}
	</delete>

	<select id="findValidMin" parameterType="java.lang.Long" resultMap="BaseResultMap">
		SELECT c.campaignId, c.mbayId, c.ratio, p.mbay 
		FROM tr_campaign_mbay c
		INNER JOIN tr_mbay p ON c.mbayId = p.id
		WHERE c.campaignid = #{value} AND c.ratio >= 1
			AND p.mbay = 
			(
				select MIN(p.mbay) from tr_campaign_mbay c 
				INNER JOIN tr_mbay p ON c.mbayId = p.id 
				WHERE c.campaignid = #{value} AND c.ratio >= 1
			)
	</select>

	<select id="countByCampaignId" parameterType="java.lang.Long" resultType="int">
		select count(*) from tr_campaign_mbay where campaignid = #{value}
	</select>
	
	<delete id="deleteCampaignMbayProduct" parameterType="Map">
		DELETE FROM
		tr_campaign_mbay WHERE campaignId=#{campaignId} AND
		mbayId=#{mbayId}
	</delete>
	
	<update id="updateMbayProductRatio" parameterType="Map">
		UPDATE
		tr_campaign_mbay SET ratio=#{ratio} WHERE campaignId=#{campaignId}
		AND mbayId=#{mbayId}
	</update>
	
</mapper>